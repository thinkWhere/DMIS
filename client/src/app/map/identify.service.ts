import {Injectable} from '@angular/core';
import {Http, Response} from '@angular/http';
import {Observable} from 'rxjs/Observable';
import * as ol from 'openlayers';

import { LayerService } from './layer.service';

@Injectable()
export class IdentifyService {

    container: any;
    content: any;
    closer: any;
    overlay: any;

    constructor(
        private http: Http,
        private layerService: LayerService
    ) {}

    /**
     * Add identify popup
     * @param map
     */
    addIdentifyPopup(map) {

        /**
         * Elements that make up the popup.
         */
        this.container = document.getElementById('popup');
        this.content = document.getElementById('popup-content');
        this.closer = document.getElementById('popup-closer');

        /**
         * Create an overlay to anchor the popup to the map.
         */
        this.overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
            element: this.container,
            autoPan: true
        }));
        map.addOverlay(this.overlay);

        /**
         * Add a click handler to hide the popup.
         * @return {boolean} Don't follow the href.
         */
        this.closer.onclick = function () {
            this.overlay.setPosition(undefined);
            this.closer.blur();
            return false;
        }.bind(this);
    }

    /**
     * Add identify event handlers
     * @param map
     * @param source
     */
    addIdentifyEventHandlers(map, source){
        /**
         * Add a click handler to the map to render the popup.
         * TODO: add identify for each layer
         */
        map.on('singleclick', (evt) => {
            var viewResolution = map.getView().getResolution();
            var url = source.getGetFeatureInfoUrl(
                evt.coordinate, viewResolution, 'EPSG:3857',
                {'INFO_FORMAT': 'application/json'});
            var identifiableLayers = this.layerService.getIdentifiableLayers(map);
            url = this.updateUrlParameter(url, 'QUERY_LAYERS', identifiableLayers.join());
            url = this.updateUrlParameter(url, 'LAYERS', identifiableLayers.join());
            if (url) {
                var coordinate = evt.coordinate;
                var parser = new ol.format.GeoJSON();
                // Mock - TODO: replace for call to API
                var response = '{"type":"FeatureCollection","totalFeatures":"unknown","features":[{"type":"Feature","id":"Cambodia_KHM_admin0.1","geometry":{"type":"MultiPolygon","coordinates":[[[[1.145767613306118E7,1110423.88399559],[1.145903671216466E7,1109665.90655819],[1.145616267990113E7,1111474.27907955],[1.145767613306118E7,1110423.88399559]]],[[[1.148177927598047E7,1154360.62559086],[1.148277890245036E7,1154226.71444857],[1.148132659891293E7,1152505.22954785],[1.148340908328357E7,1150617.34575986],[1.148223450094889E7,1149108.1462837],[1.148183278190024E7,1151558.84748256],[1.147957194446366E7,1153330.56943327],[1.14809664955797E7,1155605.12767946],[1.148177927598047E7,1154360.62559086]]],[[[1.155412692325238E7,1168471.60606221],[1.15575657402249E7,1167137.92087314],[1.155559196629451E7,1166003.86939384],[1.155579070256806E7,1164543.66718861],[1.155318165200257E7,1166065.07226914],[1.155412692325238E7,1168471.60606221]]],[[[1.152872180295131E7,1175000.2150567],[1.152829800209451E7,1173986.7235897],[1.152688901287309E7,1174926.47222526],[1.152872180295131E7,1175000.2150567]]],[[[1.153157799990825E7,1176060.05598618],[1.153345920010439E7,1174381.77339705],[1.153270332282467E7,1172474.47649752],[1.153056988043521E7,1173462.44463332],[1.153041955427956E7,1176296.62429256],[1.153157799990825E7,1176060.05598618]]],[[[1.15495797693697E7,1177696.52382275],[1.155455581991108E7,1175506.05403946],[1.155471548837016E7,1170704.06312791],[1.155160450131895E7,1168765.76843719],[1.154742424517209E7,1172562.68102318],[1.154895978014031E7,1173154.6395334],[1.154832195560429E7,1177402.39450199],[1.15495797693697E7,1177696.52382275]]],[[[1.159557957299175E7,1182733.81931742],[1.15956254352087E7,1181428.42383757],[1.159441942876243E7,1181900.12297509],[1.159557957299175E7,1182733.81931742]]],[[[1.151283988707428E7,1188098.03217371],[1.151407052322967E7,1187785.45340249],[1.151142919925226E7,1187409.04490707],[1.151283988707428E7,1188098.03217371]]],[[[1.15013029916051E7,1189180.6307014],[1.150192552873548E7,1187528.50150747],[1.149963921228942E7,1187210.85154617],[1.149990419398749E7,1184907.67933698],[1.15019144878314E7,1183614.08178999],[1.15029149636016E7,1185636.79365845],[1.150371840169893E7,1183927.91894768],[1.15012061713693E7,1180222.74753969],[1.149686794536394E7,1187838.80977265],[1.149854361488401E7,1189472.4833705],[1.15013029916051E7,1189180.6307014]]],[[[1.149230720267626E7,1206947.21371843],[1.149449839748712E7,1206221.43009766],[1.149510734581245E7,1200434.73249377],[1.149809858151933E7,1200809.77058279],[1.149930288936499E7,1198199.17564011],[1.150109321442748E7,1199128.45206862],[1.149562287110323E7,1192541.08203912],[1.149324652882386E7,1198499.20784538],[1.148939665049924E7,1198613.08463693],[1.148835710691454E7,1202100.33923661],[1.14861659121037E7,1202299.69882768],[1.148755451811757E7,1206153.78041572],[1.149019414349434E7,1205439.6846017],[1.149230720267626E7,1206947.21371843]]],[[[1.148693452888812E7,1212877.25941495],[1.148775495299171E7,1211799.31662675],[1.148557310048433E7,1211264.0869127],[1.148436369683682E7,1212967.94522301],[1.148693452888812E7,1212877.25941495]]],[[[1.147598789713736E7,1219508.88034973],[1.147336016196498E7,1219510.06954879],[1.147390711136737E7,1221400.08412391],[1.147598789713736E7,1219508.88034973]]],[[[1.14640535291211E7,1279948.09678749],[1.146448242577984E7,1278212.6260448],[1.146791529765017E7,1279318.83704793],[1.146977016953654E7,1274865.95675967],[1.146903212756342E7,1271495.27103815],[1.147088360224855E7,1266798.1408248],[1.146779129980424E7,1259610.02772105],[1.146578610176226E7,1260084.87803491],[1.146563067980472E7,1261595.41765953],[1.146463614913671E7,1260964.24065876],[1.146501069057529E7,1262979.48182146],[1.146371126109448E7,1263271.76003232],[1.146482469380647E7,1268214.47336215],[1.146256640427082E7,1276951.37085399],[1.14640535291211E7,1279948.09678749]]],[[[1.147236987779854E7,1282483.67245105],[1.147427400910315E7,1282049.87013314],[1.147308159146192E7,1279707.3303786],[1.147317926099808E7,1281091.40980274],[1.1471071297618E7,1281758.18062911],[1.147236987779854E7,1282483.67245105]]],[[[1.14744727453767E7,1284093.17895864],[1.147595732232606E7,1283681.9937739],[1.147410160113937E7,1282956.69153784],[1.14744727453767E7,1284093.17895864]]],[[[1.147301959253896E7,1285039.27150929],[1.14738850295592E7,1283461.78005859],[1.147113244724063E7,1282926.6876015],[1.147301959253896E7,1285039.27150929]]],[[[1.147518445904007E7,1285733.31431868],[1.147790561724701E7,1284502.85289114],[1.147465874214552E7,1284124.15887763],[1.147394702848216E7,1285417.75967034],[1.147513944612342E7,1284633.59868676],[1.147518445904007E7,1285733.31431868]]],[[[1.147661637936994E7,1286133.58463789],[1.147836933521862E7,1285260.14599827],[1.14768227593463E7,1284597.31044652],[1.147661637936994E7,1286133.58463789]]],[[[1.147116472065258E7,1289677.52215305],[1.147456531911094E7,1287721.06587262],[1.147413302525098E7,1286553.46761579],[1.147120293916672E7,1286668.730572],[1.147116472065258E7,1289677.52215305]]],[[[1.146825671637649E7,1292171.17806308],[1.146763927504803E7,1288478.43502819],[1.146893785522852E7,1290245.77168067],[1.147011328686349E7,1288321.02297034],[1.146884528149428E7,1287089.70387632],[1.147014386167484E7,1287941.95884476],[1.146955614585734E7,1286711.41263653],[1.147385445474792E7,1285480.91368203],[1.147097957318408E7,1283525.14686081],[1.146974214262616E7,1285607.43873144],[1.147073157749229E7,1282609.75242483],[1.14679484203624E7,1279865.13344022],[1.146748470239082E7,1284124.15887763],[1.146402210500948E7,1289677.52215305],[1.146825671637649E7,1292171.17806308]]],[[[1.197166673816108E7,1652961.08183735],[1.197324643674567E7,1652780.21828277],[1.197232664450528E7,1649702.11542837],[1.197357426666697E7,1645531.38032356],[1.196882073280793E7,1641177.70094771],[1.197051084043335E7,1636697.43424025],[1.196775316231287E7,1632396.8101965],[1.196568936254921E7,1620755.80962147],[1.196252741747913E7,1620616.82627766],[1.196133160263663E7,1622053.4988338],[1.196025808703935E7,1617875.89538794],[1.19567912431565E7,1615747.51359093],[1.195476905910817E7,1611459.61275491],[1.195653390516125E7,1608266.86055716],[1.195667403971311E7,1601039.84132332],[1.195314264900633E7,1594731.10032214],[1.195115103976935E7,1593717.16615811],[1.194820991278101E7,1586215.16838532],[1.19538356780628E7,1583071.70213201],[1.195180075450977E7,1581515.48707392],[1.195089624967507E7,1577313.43383916],[1.195399619582219E7,1572671.46925144],[1.196049674042767E7,1573751.9865247],[1.196178682760505E7,1571818.00566595],[1.196152609240861E7,1566098.61819605],[1.196388629798197E7,1564612.19982447],[1.196176814299817E7,1559332.64227435],[1.196391432489235E7,1557714.84207533],[1.196139360155955E7,1550471.86552423],[1.197053547014245E7,1544702.19715935],[1.197987437639829E7,1519679.43858521],[1.198129865302532E7,1500896.3186387],[1.196572163596112E7,1463556.52538563],[1.196736842927052E7,1456836.28549898],[1.196544731195961E7,1456166.94185989],[1.196512967364207E7,1453265.43658259],[1.196709580386962E7,1450027.55976116],[1.196596538515135E7,1447738.85109192],[1.19729228533259E7,1438818.94697956],[1.197431740444196E7,1428702.5084714],[1.19734579125239E7,1426316.13569812],[1.19759675949526E7,1423024.16252342],[1.197459937214629E7,1418875.63859568],[1.197686020958291E7,1409304.41419164],[1.197374072952854E7,1405134.89024767],[1.197565505243695E7,1402073.54094533],[1.197181196851484E7,1393075.21662289],[1.197294408583376E7,1388931.02473576],[1.1972012403389E7,1386052.40887665],[1.196063772427985E7,1378880.55294865],[1.19594521010411E7,1373544.53037834],[1.195755646273966E7,1372989.19956854],[1.19494779181502E7,1383790.22883672],[1.194644251882697E7,1382258.7685331],[1.194554565769511E7,1383595.49114619],[1.194111231005455E7,1382692.02050278],[1.193671548232754E7,1379313.53869496],[1.193235857171526E7,1379249.54116035],[1.192802459221151E7,1377064.57998952],[1.192664702710173E7,1371765.37876547],[1.192360653197665E7,1370646.75490405],[1.192158180002738E7,1366256.19339461],[1.191954517787375E7,1367085.31468174],[1.192007683987049E7,1364249.84436318],[1.191786016605022E7,1364024.28231604],[1.191681977316522E7,1360989.62065409],[1.191177407999809E7,1358768.41250314],[1.191267518763151E7,1358090.76786579],[1.191044152780499E7,1355563.49606643],[1.190185425232728E7,1352697.07641197],[1.188808539563221E7,1355095.457539],[1.188007054856632E7,1342128.28852664],[1.187640496840992E7,1341561.70234386],[1.18727657165632E7,1344445.2039993],[1.187327105025021E7,1341777.87419757],[1.187136946684655E7,1342856.58577204],[1.187051167352912E7,1341238.74963262],[1.18696768113202E7,1342734.93039042],[1.185875990508042E7,1342062.41597121],[1.18595200288617E7,1342850.83399026],[1.185743075008858E7,1343426.88570657],[1.185435373504995E7,1342189.82034921],[1.185049961022373E7,1344404.28828945],[1.184568152954085E7,1342686.96292354],[1.18518117792093E7,1330598.71895152],[1.184881629700083E7,1329465.76281419],[1.184966135081355E7,1325663.43713025],[1.184593971683637E7,1319058.57733603],[1.185028049074265E7,1310483.69899493],[1.184999172863582E7,1308207.03546936],[1.184259602149905E7,1311170.38369046],[1.183316539080928E7,1308720.76370291],[1.182762710345987E7,1314748.12999494],[1.182300690975021E7,1315069.94006019],[1.182082335864216E7,1317625.78006852],[1.181704397224362E7,1315718.99156329],[1.181201866228403E7,1316577.98081473],[1.180662560528835E7,1320934.7702443],[1.180178034699541E7,1319522.49109605],[1.180151536529734E7,1314568.5770264],[1.179463942995295E7,1304636.75231198],[1.178676556673925E7,1308909.3893803],[1.178169949036456E7,1305615.43172812],[1.17806888229906E7,1302414.91886199],[1.177867683054603E7,1302289.51928229],[1.17795235829594E7,1296639.68257878],[1.178443508667687E7,1296333.01427407],[1.178655748816225E7,1294001.45652123],[1.178591201992341E7,1284455.62421772],[1.178909264960039E7,1282763.3453635],[1.178546698655873E7,1277913.71515328],[1.178681142895622E7,1272755.12229934],[1.17847297938859E7,1263804.68737752],[1.178955806617259E7,1263895.40388882],[1.179161931803537E7,1256771.02765262],[1.179572738365551E7,1254337.77922539],[1.180101682601287E7,1253699.05839554],[1.180237146001414E7,1248017.67248647],[1.180974253744178E7,1243360.68919648],[1.181129251051534E7,1240200.39837009],[1.181690893349366E7,1243598.80772544],[1.182067642968779E7,1237913.7482869],[1.182270116163704E7,1229626.91647093],[1.181580484308509E7,1229570.14221271],[1.181657430916986E7,1225431.50364861],[1.181510077312456E7,1222538.01437078],[1.182064330697555E7,1213991.5551193],[1.182102294421602E7,1208158.9047725],[1.181810050183462E7,1210772.42229485],[1.180783840613715E7,1210797.38904514],[1.179367292619527E7,1222731.006828],[1.179491460325478E7,1218924.12381758],[1.179200320177741E7,1216588.87425184],[1.179265546441876E7,1213880.00500169],[1.178304563136272E7,1216560.76835079],[1.178468563026956E7,1220692.47846227],[1.177492971755944E7,1235791.55223606],[1.174822007197567E7,1226623.09548513],[1.174373067051438E7,1226248.96137188],[1.174125665869889E7,1228099.45209404],[1.173881916679692E7,1227056.27446739],[1.173604535197047E7,1229081.56314487],[1.173392549838601E7,1224280.71690455],[1.172624357704335E7,1216168.69346486],[1.171800536399484E7,1220384.14218213],[1.171509141461654E7,1219924.02147219],[1.170578138457144E7,1223379.40471349],[1.170031273984778E7,1222940.54274803],[1.170151534909281E7,1227597.37758561],[1.169787524794578E7,1227216.20391709],[1.169724251921164E7,1224931.52343533],[1.169451966240405E7,1224315.74919982],[1.169169573885907E7,1219704.55821147],[1.16955447678834E7,1207550.56823111],[1.16987619174739E7,1204426.3814687],[1.169945664513098E7,1200464.22972293],[1.168371401450548E7,1191042.61090658],[1.167383410394948E7,1177908.37621137],[1.166114640655446E7,1177427.12113734],[1.164918146372686E7,1179924.9254612],[1.164916362842028E7,1178729.23537082],[1.164354465754101E7,1179064.51686209],[1.164208131309949E7,1175908.7869949],[1.163948839924001E7,1174583.24079704],[1.163848622486914E7,1170387.75377451],[1.163596804943733E7,1169409.69575968],[1.163266257261411E7,1164807.46625123],[1.163055715713503E7,1167581.685386],[1.162619005491901E7,1166665.55690597],[1.162466131435331E7,1169100.63076437],[1.162054900223157E7,1170043.81106648],[1.161618869441805E7,1175012.4155694],[1.160947837263493E7,1172936.87796412],[1.160842778814615E7,1178691.87409012],[1.160459319722717E7,1183472.93159017],[1.160105161491663E7,1183417.20603785],[1.160131574731437E7,1181963.08147067],[1.159726458481527E7,1179855.7075687],[1.159575028235492E7,1183213.20376033],[1.158857454399955E7,1180673.48093437],[1.158350422112333E7,1180862.13413606],[1.157043858508842E7,1185375.64563413],[1.156636194357988E7,1192573.16506913],[1.156192265083713E7,1193060.7875877],[1.156175448937491E7,1199122.72572135],[1.156093236667071E7,1192533.19631581],[1.156265984350995E7,1189405.08268354],[1.155496348406193E7,1177622.66732876],[1.155320628171171E7,1179473.22989704],[1.155005792544667E7,1178955.34755909],[1.154502836898549E7,1181664.27260756],[1.15479440169644E7,1178725.56402933],[1.154737923225541E7,1175455.19988591],[1.154149273177715E7,1176477.8036576],[1.153629331525311E7,1173985.10409983],[1.153353393853202E7,1175955.32292468],[1.153433822592966E7,1179097.23532504],[1.153290885350072E7,1181513.51927186],[1.153149222057651E7,1182246.23412265],[1.152885259519974E7,1179833.13889399],[1.152451012269279E7,1187196.16260103],[1.152284634337711E7,1188237.04098542],[1.15216479806337E7,1187067.31057718],[1.152050227450973E7,1189316.61948114],[1.152127089129416E7,1191659.51253592],[1.152301960064125E7,1191936.26309135],[1.152347142840844E7,1194386.60693179],[1.152617899781037E7,1196251.78505173],[1.152643124000373E7,1200476.65530323],[1.153061489335187E7,1202915.28967317],[1.154318199010227E7,1203516.1956838],[1.153977969304324E7,1203737.2833426],[1.153907307518177E7,1205467.02485957],[1.15409253991672E7,1210515.51441811],[1.154475914078585E7,1213652.25798411],[1.154515576403263E7,1217790.42335676],[1.154198957246101E7,1227643.55125744],[1.153913167690343E7,1231758.77845275],[1.153981111715485E7,1234626.67332966],[1.153801824419144E7,1238029.38049013],[1.154441857135982E7,1239447.28681748],[1.154271827213065E7,1240329.56055549],[1.154624201913462E7,1244866.99894595],[1.15522729006663E7,1247829.40264655],[1.155326233553243E7,1246789.50162145],[1.155307718806394E7,1248081.51135409],[1.154667516229487E7,1245875.67950128],[1.154033683404943E7,1239289.89493351],[1.153922340133738E7,1241212.18226998],[1.153186421411415E7,1242692.86294243],[1.152750475560094E7,1251138.67213529],[1.152314444778743E7,1251233.357429],[1.151927928205714E7,1248554.35562473],[1.151903128636537E7,1250350.79283583],[1.151757813352768E7,1245938.54047905],[1.151458010341824E7,1243197.32854218],[1.151297067932271E7,1244110.75213104],[1.151819642415643E7,1243543.41607479],[1.151170352325379E7,1227634.03536671],[1.151318725090281E7,1219824.01956315],[1.150687949746866E7,1218499.15735961],[1.150531593559007E7,1216775.99528806],[1.150359185595211E7,1220397.6561606],[1.149632184526188E7,1224444.95813537],[1.149691550618154E7,1223285.55545552],[1.149312507887892E7,1222780.63363859],[1.148935928128542E7,1218904.77264673],[1.149098569138724E7,1218753.09876972],[1.148625423933641E7,1217336.28358548],[1.148618035020905E7,1215878.45071334],[1.148321034701002E7,1217768.80266284],[1.148181070009207E7,1216424.56316098],[1.147956175285985E7,1217383.63231753],[1.148047729859866E7,1219784.99187144],[1.14769229767834E7,1222592.72248443],[1.147651361403194E7,1224736.46396731],[1.14780287657926E7,1232358.68315046],[1.147577132555726E7,1241086.04565456],[1.147775104458983E7,1241148.68118665],[1.14789570510361E7,1243386.0047607],[1.147824533737272E7,1248743.27882262],[1.148121364197115E7,1247419.86535173],[1.148013163337075E7,1244961.55806058],[1.148139199503715E7,1247293.92148215],[1.147790561724701E7,1249342.19198795],[1.147456531911094E7,1257316.9451197],[1.1471071297618E7,1257412.08115189],[1.147382303063629E7,1259177.07242084],[1.14736998820907E7,1264475.32435352],[1.147574075074592E7,1264568.42436252],[1.147574075074592E7,1261698.90110964],[1.147614246979457E7,1266145.1025957],[1.147923477223885E7,1268195.52644876],[1.148192195843326E7,1268176.14647451],[1.148198735455744E7,1265262.13606082],[1.148436794333839E7,1264852.27277584],[1.148226507576021E7,1266208.21894798],[1.148090194875579E7,1271701.43500911],[1.147644821790774E7,1271984.58776844],[1.147601932124902E7,1277499.03502831],[1.147379755162685E7,1279760.40064252],[1.147886362800152E7,1284755.57080396],[1.148306936315785E7,1281632.10399428],[1.148087477114575E7,1284691.87660322],[1.148189393152288E7,1287121.55334264],[1.148005094984089E7,1288358.29044882],[1.148031763013956E7,1286585.42487881],[1.147815276363846E7,1285386.02022254],[1.147178301128136E7,1289046.44657308],[1.147277244614751E7,1290971.56398935],[1.147036043325494E7,1291602.78593486],[1.147175158716976E7,1295863.37320825],[1.147063900375805E7,1295011.01513247],[1.147023643540908E7,1296400.09094042],[1.147156559040094E7,1298514.75810843],[1.147029758503168E7,1297094.27230836],[1.14694941469344E7,1299903.44517252],[1.146974214262616E7,1293779.97987236],[1.14674065667619E7,1295995.57419169],[1.146773184878227E7,1294064.30242603],[1.146575297904997E7,1293653.85589313],[1.146572240423869E7,1296147.93108823],[1.146523745375924E7,1293699.14778017],[1.146411382944345E7,1294159.11329278],[1.146538183481266E7,1292991.27978238],[1.146451639779242E7,1291761.08093387],[1.146148609427103E7,1293527.73241296],[1.146386158725009E7,1291041.98806455],[1.146089837845356E7,1293370.07876438],[1.146179523958544E7,1296716.07920661],[1.146405183052049E7,1295642.10033207],[1.146239739350825E7,1297046.48318962],[1.146377410931774E7,1304449.45285022],[1.146646384341304E7,1304449.45285022],[1.146717555707639E7,1302460.44000773],[1.147038336436345E7,1303912.70729683],[1.146717555707639E7,1302618.35553722],[1.146615469809865E7,1305333.60710333],[1.146414525355505E7,1305838.61693596],[1.146408325463211E7,1307827.84240842],[1.146384545054413E7,1305099.4777881],[1.146269125141703E7,1307038.35930271],[1.146265727940445E7,1303949.77626476],[1.146167039243927E7,1308585.47425711],[1.146416903396386E7,1311949.996055],[1.146229208026928E7,1312345.82666828],[1.146281524926289E7,1314049.98264433],[1.146040238707001E7,1318716.33961772],[1.145590194470464E7,1321711.15514712],[1.145384833654472E7,1326462.17547547],[1.145542463792805E7,1321597.28270735],[1.146006351624461E7,1318564.958095],[1.146210523420017E7,1314269.5412104],[1.146003209213302E7,1305964.78935875],[1.146139267123648E7,1305743.87955458],[1.146188781331969E7,1302366.03789503],[1.14609603773765E7,1296336.48188505],[1.145836236771513E7,1298735.61749537],[1.14587955108754E7,1301639.87720366],[1.145595884782574E7,1305793.84969402],[1.145527855827397E7,1319393.0109672],[1.144745395447853E7,1329285.79972785],[1.144548272844907E7,1338080.91503698],[1.144163879522663E7,1344448.78548312],[1.14405117737096E7,1353820.46628745],[1.143656507514913E7,1357990.55027266],[1.143301160263418E7,1365285.04042195],[1.143546947774374E7,1387141.72021402],[1.143775664349007E7,1389948.81237296],[1.144204391147655E7,1391233.37880677],[1.144210421179888E7,1393714.7341472],[1.143995208480251E7,1397466.45693938],[1.143667803209093E7,1398730.58264329],[1.143696849279841E7,1400667.70173975],[1.143486392661965E7,1401055.33653501],[1.143584486848262E7,1403843.0864319],[1.143405709132108E7,1403333.40554678],[1.143015625497758E7,1406958.67148466],[1.14309664874774E7,1408046.36019829],[1.142845085994652E7,1411838.5230431],[1.142644905910576E7,1412232.17907306],[1.142662486427082E7,1415095.18257264],[1.142354699993187E7,1415542.40601474],[1.141939052419377E7,1419862.5826772],[1.141406710982389E7,1419994.99740832],[1.141167038433699E7,1421813.72083384],[1.141051618520986E7,1429711.22828911],[1.141454611520111E7,1434754.92008379],[1.141381316902992E7,1438664.88888359],[1.141031914753696E7,1443299.07826951],[1.141157016689989E7,1447438.48122044],[1.140892629502153E7,1453435.80401228],[1.141063253935291E7,1455006.30423423],[1.140893988382655E7,1456969.85107466],[1.141391338646698E7,1459700.45702369],[1.140988940157791E7,1461026.90535136],[1.140606075576115E7,1468798.23943566],[1.140320710670516E7,1469797.15047675],[1.139917293021234E7,1477469.29409132],[1.139564153950557E7,1489564.48468017],[1.139366097117266E7,1491264.0790937],[1.13948092251976E7,1495448.28215069],[1.139320065040231E7,1499278.29224694],[1.139495275695069E7,1505917.07091732],[1.139527718967076E7,1517247.66219131],[1.139193604223436E7,1521064.87939252],[1.139261463318546E7,1523511.95748512],[1.139560332099144E7,1525666.99679197],[1.140363855126484E7,1523563.39336703],[1.140823411526538E7,1525020.01929535],[1.14134029569781E7,1524080.92456305],[1.141742864046777E7,1525726.51862174],[1.141871278254299E7,1528579.56930979],[1.142427060379961E7,1529165.6821745],[1.141898540794385E7,1531439.14669916],[1.141613855329039E7,1535635.39352604],[1.142058379113533E7,1540390.23842298],[1.143626102563661E7,1548096.88872876],[1.14353004669812E7,1550257.60941853],[1.144027396962158E7,1557504.90157053],[1.144196068004575E7,1566286.86005336],[1.145128429889594E7,1574478.04547656],[1.14562620480379E7,1575975.41375186],[1.145508491780234E7,1583554.81629744],[1.145758440862724E7,1586144.01782592],[1.145956582626046E7,1591293.51966919],[1.145825875307677E7,1594313.14881211],[1.145955818255763E7,1596598.00313124],[1.146120072936545E7,1596589.89967984],[1.146081090052118E7,1597729.11641273],[1.146586933319304E7,1598610.80347094],[1.146975488213087E7,1601688.67461803],[1.147253294345888E7,1606727.65263428],[1.147993629429845E7,1608679.44959719],[1.148190412312664E7,1611487.11458484],[1.148326215432918E7,1610085.54472514],[1.148544740403784E7,1612551.05252291],[1.149057887653669E7,1611159.61461967],[1.149559654279348E7,1614333.21962872],[1.151160755231826E7,1615081.12225302],[1.151458774712106E7,1618906.77898477],[1.151814121963601E7,1615919.89488835],[1.152183652530345E7,1620065.06545007],[1.152838972652842E7,1622726.97710296],[1.153408938093756E7,1622212.00140341],[1.153555782118095E7,1619774.39288693],[1.153897455634532E7,1621090.3372892],[1.153757490942737E7,1622459.2936782],[1.153939156279962E7,1624345.52393701],[1.154497995886757E7,1623738.76241972],[1.154508272420559E7,1617354.22224486],[1.155055816333177E7,1617425.34890466],[1.155247843134237E7,1615470.69772702],[1.155545607824424E7,1616453.15547604],[1.155552487156966E7,1615015.59086837],[1.155806258090876E7,1614575.6144059],[1.156036843126202E7,1616655.56945055],[1.156426162390268E7,1612856.65517684],[1.156636109427956E7,1613718.58596296],[1.157105517711659E7,1611922.54587313],[1.157181869809913E7,1614212.35183839],[1.157526346017384E7,1614767.6032097],[1.15769561157002E7,1613649.33238535],[1.157837359792475E7,1614963.97680162],[1.158068539338019E7,1612759.02410342],[1.158699739331593E7,1613907.82888863],[1.158949518554022E7,1617472.58412961],[1.159286181198605E7,1616891.08181513],[1.159362193576731E7,1614712.37340706],[1.159690702938293E7,1615427.08251423],[1.159645520161578E7,1617196.73602712],[1.159807566661541E7,1618195.3706221],[1.160179730059257E7,1616211.94848453],[1.160506031240002E7,1617430.06146382],[1.160817299805187E7,1621019.09086042],[1.161435250713857E7,1616603.73291001],[1.161930987307303E7,1618042.37272416],[1.162594630572883E7,1615130.65444721],[1.162874984606626E7,1615367.35828507],[1.162920676963532E7,1613640.23738823],[1.16330719353656E7,1617091.96493748],[1.164013726468011E7,1614433.15788593],[1.164910842389984E7,1622600.80819506],[1.165307975216941E7,1618896.25731862],[1.165601918055714E7,1623676.49755313],[1.165796917407872E7,1622548.85002442],[1.165807278871709E7,1620296.11522192],[1.166716964438331E7,1624190.1872334],[1.167105264542021E7,1620329.32605759],[1.167456110501848E7,1622017.98386975],[1.16827746883579E7,1617982.64241686],[1.168566146012614E7,1619069.97496363],[1.168805988421366E7,1617678.18440369],[1.168896608764901E7,1615710.91148073],[1.168707044934753E7,1610526.64972742],[1.169176283358393E7,1604409.70171522],[1.169138744284502E7,1601581.88544291],[1.169429969362265E7,1598704.00055988],[1.170066010367632E7,1598540.9332522],[1.170461444593961E7,1601365.89883496],[1.170556905949286E7,1606744.85181778],[1.170838788723595E7,1610163.553804],[1.170744176668581E7,1612521.13894056],[1.171099269129984E7,1614043.48854143],[1.171172224026982E7,1609804.07853483],[1.171556022839002E7,1605311.22410956],[1.171940755881373E7,1594175.29307822],[1.172443286877332E7,1592627.50466074],[1.172904966528173E7,1585934.0700718],[1.17329538988265E7,1585489.77013166],[1.173490134444711E7,1586767.41276607],[1.173937375990212E7,1585629.87868541],[1.175093528508041E7,1592378.41741689],[1.175399106761118E7,1589746.12120367],[1.175392652078729E7,1591038.75205986],[1.175569136684037E7,1590945.8013683],[1.175741884367964E7,1588381.19348487],[1.175930344107702E7,1589004.5322833],[1.176054426883616E7,1585142.12902039],[1.176202629788461E7,1587731.48753465],[1.176707368965235E7,1583913.92890253],[1.176933367778866E7,1586480.39748276],[1.177075795441568E7,1584774.68088489],[1.177619347642707E7,1583534.02053377],[1.17769493537068E7,1576669.58251473],[1.179013898758759E7,1565756.8111535],[1.180095227918898E7,1565879.64242477],[1.181172735227626E7,1563617.91010005],[1.181158212192252E7,1572426.94763666],[1.181926913906706E7,1576699.56436479],[1.182091763097706E7,1581144.80651376],[1.181457590553036E7,1586256.54526113],[1.18122607128736E7,1595292.50396141],[1.180655511336226E7,1597141.04963442],[1.180386537926694E7,1600745.87830606],[1.180281819197943E7,1609479.01027001],[1.179995689922064E7,1610846.14330683],[1.180018960750676E7,1616614.03445521],[1.180314347399981E7,1613581.6130861],[1.180740356437624E7,1614309.00219283],[1.18088448270096E7,1612676.29548121],[1.180914802722178E7,1615831.56713705],[1.181158212192252E7,1617085.17017449],[1.181356523815635E7,1614918.93785986],[1.181617428872179E7,1616645.15829766],[1.181787288935035E7,1614550.30092048],[1.182130491192037E7,1614046.99510092],[1.182446770629075E7,1615554.53119547],[1.182647120573212E7,1619726.38619683],[1.182826238009494E7,1629953.40560695],[1.183535828422077E7,1624527.06188673],[1.184574607636474E7,1625788.21616065],[1.184908892240173E7,1630074.23804293],[1.184846723457167E7,1633996.23059468],[1.185338468339136E7,1633290.21419008],[1.185139647135562E7,1637566.85957315],[1.185702223663743E7,1641654.66575002],[1.186047039591337E7,1642105.64050286],[1.186353721934824E7,1634222.69076771],[1.186289514831065E7,1631345.86420726],[1.18669548038129E7,1632337.04634946],[1.187026962293957E7,1624872.05331643],[1.187376619233343E7,1625476.64914037],[1.187380526014788E7,1624281.28436723],[1.187970959593275E7,1622445.37246277],[1.188073724931306E7,1623998.4567804],[1.188260571000448E7,1623158.10457021],[1.188748663891062E7,1613150.75595552],[1.189336974218766E7,1607645.36008681],[1.189501483689641E7,1606993.09098927],[1.189636182719484E7,1609643.13252896],[1.189953736106995E7,1609768.47092494],[1.190059813716248E7,1612074.19251798],[1.190762015216094E7,1609580.13487624],[1.190854079370161E7,1613495.37533667],[1.191642739642001E7,1621760.39223954],[1.191585072150664E7,1624742.1465598],[1.191843429306267E7,1624106.21591479],[1.192139580325855E7,1618879.26922086],[1.193051389143267E7,1621939.71958564],[1.193464913466289E7,1629388.72440778],[1.194018657271199E7,1629970.62035637],[1.194058149735812E7,1635021.95228025],[1.194241768463763E7,1635638.30446936],[1.194509298062761E7,1641203.91842091],[1.194913395152294E7,1641142.70779356],[1.195378896654549E7,1635347.45456344],[1.196122544009735E7,1634348.03980782],[1.196304803857177E7,1644165.89981114],[1.196650978665278E7,1645421.99434413],[1.196912308371983E7,1648658.46175565],[1.19697770449618E7,1652352.31872621],[1.197166673816108E7,1652961.08183735]]]]},"geometry_name":"geom","properties":{"id":1,"id_0":40,"iso":"KHM","name_engli":"Cambodia","name_iso":"CAMBODIA","name_fao":"Cambodia","name_local":"Kampuchea","name_obsol":null,"name_varia":"Kampuchea|Khmer Republic","name_nonla":null,"name_frenc":"Cambodge","name_spani":"Camboya","name_russi":"Камбоджа","name_arabi":"كمبوديا","name_chine":"柬埔寨","waspartof":null,"contains":null,"sovereign":"Cambodia","iso2":"KH","www":null,"fips":"CB","ison":116,"validfr":"19490719","validto":"Present","pop2000":1.310403E7,"sqkm":182612.297,"popsqkm":71.7587490836,"unregion1":"South-Eastern Asia","unregion2":"Asia","developing":1,"cis":0,"transition":0,"oecd":0,"wbregion":"East Asia & Pacific","wbincome":"Low income","wbdebt":"Moderately indebted","wbother":null,"ceeac":0,"cemac":0,"ceplg":0,"comesa":0,"eac":0,"ecowas":0,"igad":0,"ioc":0,"mru":0,"sacu":0,"uemoa":0,"uma":0,"palop":0,"parta":0,"cacm":0,"eurasec":0,"agadir":0,"saarc":0,"asean":1,"nafta":0,"gcc":0,"csn":0,"caricom":0,"eu":0,"can":0,"acp":0,"landlocked":0,"aosis":0,"sids":0,"islands":0,"ldc":1}}],"crs":{"type":"name","properties":{"name":"urn:ogc:def:crs:EPSG::3857"}}}';
                var result = parser.readFeatures(response);
                if (result.length) {
                    var info = [];
                    // TODO: create template for popup?
                    var tableContent = '<table class="table table-condensed">';
                    tableContent += '<tbody>';
                    tableContent += '<thead><tr><th>Property</th><th>Value</th></tr></thead>';
                    for (var i = 0, ii = result.length; i < ii; ++i) {
                        var properties = result[i].getKeys();
                        // exclude geometry property
                        for (var j = 0; j < properties.length; j++) {
                            if (properties[j] !== 'geometry') {
                                tableContent += '<tr>';
                                // Property key
                                tableContent += '<th scope="row">';
                                tableContent += properties[j];
                                tableContent += '</td>';
                                // Property value
                                tableContent += '<td>';
                                tableContent += result[i].get(properties[j]);
                                tableContent += '</td>';
                                tableContent += '</tr>';
                            }
                        }
                    }
                    tableContent += '</tbody>';
                    tableContent += '</table>';
                    this.content.innerHTML = tableContent;
                } else {
                    this.content.innerHTML = '&nbsp;';
                }
                this.overlay.setPosition(coordinate);
                // TODO: use getFeatureInfo function to get the response from the server instead of mock
            }
        });
    }

    /**
     * Make a GetFeatureInfo call
     * @param url
     * @returns {any|Promise<R>|Maybe<T>}
     */
    private getFeatureInfo(url) {
        return this.http.get(url)
            .map(response => response.json())
            .catch(this.handleError);
    }

    /**
     * Handle the error
     * @param error
     * @returns {ErrorObservable}
     */
    private handleError(error:Response | any) {
        return Observable.throw(error);
    }
    
    /**
     * Add/update a key-value pair in the URL query parameters
     * @param uri
     * @param key
     * @param value
     * @returns {string}
     */
    private updateUrlParameter(uri, key, value) {
        // remove the hash part before operating on the uri
        var i = uri.indexOf('#');
        var hash = i === -1 ? '' : uri.substr(i);
        uri = i === -1 ? uri : uri.substr(0, i);

        var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
        var separator = uri.indexOf('?') !== -1 ? "&" : "?";
        if (uri.match(re)) {
            uri = uri.replace(re, '$1' + key + "=" + value + '$2');
        } else {
            uri = uri + separator + key + "=" + value;
        }
        return uri + hash;  // finally append the hash as well
    }
}
